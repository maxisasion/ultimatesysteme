<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ULTIMATE FX TRADER</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #6d28d9;
      --secondary-color: #4c1d95;
      --accent-color: #8b5cf6;
      --dark-bg: #0f172a;
      --darker-bg: #020617;
      --text-color: #f8fafc;
      --highlight-color: #d946ef;
      --success-color: #10b981;
      --danger-color: #ef4444;
    }
    
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to right, var(--darker-bg), var(--dark-bg));
      color: var(--text-color);
      min-height: 100vh;
    }
    
    header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      padding: 15px 20px;
      text-align: center;
      font-size: 28px;
      font-weight: bold;
      color: #fff;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }
    
    .menu-btn {
      background: transparent;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      z-index: 1001;
    }
    
    .menu-container {
      position: fixed;
      top: 0;
      left: -300px;
      width: 250px;
      height: 100vh;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
      z-index: 1000;
      transition: all 0.3s ease;
      padding-top: 70px;
      box-shadow: 5px 0 15px rgba(0,0,0,0.3);
    }
    
    .menu-container.open {
      left: 0;
    }
    
    .menu-item {
      padding: 15px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
    }
    
    .menu-item i {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }
    
    .menu-item:hover {
      background: rgba(139, 92, 246, 0.2);
      padding-left: 25px;
    }
    
    .container {
      padding: 25px;
      max-width: 900px;
      margin: auto;
      text-align: center;
      backdrop-filter: blur(5px);
      background: rgba(15, 23, 42, 0.7);
      border-radius: 15px;
      margin-top: 20px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    input, select, button {
      padding: 14px 18px;
      margin: 12px 0;
      width: 90%;
      max-width: 400px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s ease;
      font-family: 'Poppins', sans-serif;
    }
    
    input, select {
      background: rgba(2, 6, 23, 0.7);
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 15px rgba(139, 92, 246, 0.5);
      background: rgba(2, 6, 23, 0.9);
    }
    
    button {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      letter-spacing: 0.5px;
    }
    
    button:hover {
      background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    iframe {
      width: 100%;
      height: 500px;
      border: none;
      margin-top: 20px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
      background: var(--darker-bg);
    }
    
    .hidden { display: none; }
    
    #signal-message {
      font-size: 18px;
      font-weight: bold;
      margin: 20px 0;
      padding: 15px;
      border-radius: 8px;
      background: rgba(2, 6, 23, 0.6);
      border-left: 4px solid var(--highlight-color);
    }
    
    .signal-buy {
      color: var(--success-color);
      border-left-color: var(--success-color) !important;
    }
    
    .signal-sell {
      color: var(--danger-color);
      border-left-color: var(--danger-color) !important;
    }
    
    .signal-neutral {
      color: var(--highlight-color);
    }
    
    .footer-message {
      font-size: 14px;
      color: var(--highlight-color);
      margin-top: 25px;
      line-height: 1.6;
    }
    
    .user-greeting {
      font-size: 22px;
      margin-bottom: 20px;
      color: var(--accent-color);
    }
    
    .premium-badge {
      background: linear-gradient(135deg, #d946ef, #a855f7);
      color: white;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 12px;
      margin-left: 10px;
      vertical-align: middle;
    }
    
    .time-display {
      font-size: 14px;
      opacity: 0.8;
      margin-top: 5px;
    }
    
    .price-levels {
      display: flex;
      justify-content: space-around;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    
    .price-level {
      background: rgba(2, 6, 23, 0.7);
      padding: 10px 15px;
      border-radius: 8px;
      margin: 5px;
      min-width: 120px;
    }
    
    .price-level span {
      font-weight: bold;
      color: var(--highlight-color);
    }
    
    .trading-levels {
      display: flex;
      justify-content: space-around;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    
    .trading-level {
      background: rgba(2, 6, 23, 0.7);
      padding: 10px 15px;
      border-radius: 8px;
      margin: 5px;
      min-width: 120px;
    }
    
    .trading-level span {
      font-weight: bold;
    }
    
    .take-profit {
      color: var(--success-color);
    }
    
    .stop-loss {
      color: var(--danger-color);
    }
    
    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid var(--accent-color);
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 10px;
    }
    
    .stat-item {
      background: rgba(2, 6, 23, 0.7);
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      font-size: 14px;
    }
    
    .fractal-signal {
      background: rgba(217, 70, 239, 0.2);
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      font-size: 14px;
      border-left: 3px solid var(--highlight-color);
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 15px;
        margin: 10px;
      }
      
      iframe {
        height: 400px;
      }
      
      header {
        font-size: 22px;
        padding: 12px 15px;
      }
      
      .price-levels,
      .trading-levels {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <header>
    <button class="menu-btn" onclick="toggleMenu()">
      <i class="fas fa-bars"></i>
    </button>
    <span>ULTIMATE FX</span>
    <div style="width: 40px;"></div>
  </header>

  <div class="menu-container" id="menuContainer">
    <div class="menu-item" onclick="navigate('dashboard')">
      <i class="fas fa-chart-line"></i> Trading Dashboard
    </div>
    <div class="menu-item" onclick="navigate('signals')">
      <i class="fas fa-bell"></i> Signal History
    </div>
    <div class="menu-item" onclick="navigate('account')">
      <i class="fas fa-user"></i> Account Settings
    </div>
    <div class="menu-item" onclick="navigate('education')">
      <i class="fas fa-graduation-cap"></i> Trading Education
    </div>
    <div class="menu-item" onclick="navigate('support')">
      <i class="fas fa-headset"></i> Customer Support
    </div>
    <div class="menu-item" onclick="deactivateLicense()">
      <i class="fas fa-sign-out-alt"></i> Logout
    </div>
  </div>

  <div class="container" id="login-container">
    <h2>Access Your Trading Portal</h2>
    <input id="mentorId" placeholder="Mentor ID" />
    <input id="email" placeholder="Email" type="email" />
    <input id="username" placeholder="Username" />
    <input id="licenseKey" placeholder="License Key" />
    <button onclick="login()"><i class="fas fa-lock-open"></i> Login</button>
  </div>

  <div class="container hidden" id="dashboard">
    <div class="user-greeting">
      Welcome back, <span id="userNameDisplay"></span> <span class="premium-badge">PREMIUM</span>
    </div>
    <div class="time-display" id="timeDisplay"></div>
    
    <select id="pairSelect" onchange="updateChart(); generateSignal();">
      <option value="EUR/USD">EUR/USD</option>
      <option value="GBP/USD">GBP/USD</option>
      <option value="USD/JPY">USD/JPY</option>
      <option value="AUD/USD">AUD/USD</option>
      <option value="USD/CAD">USD/CAD</option>
      <option value="USD/CHF">USD/CHF</option>
      <option value="NZD/USD">NZD/USD</option>
      <option value="EUR/GBP">EUR/GBP</option>
      <option value="EUR/JPY">EUR/JPY</option>
      <option value="GBP/JPY">GBP/JPY</option>
      <option value="XAU/USD">Gold (XAU/USD)</option>
      <option value="BTC/USD">BTC/USD</option>
    </select>
    
    <div class="action-buttons">
      <button onclick="showAdvancedAnalysis()"><i class="fas fa-chart-bar"></i> Advanced Analysis</button>
    </div>
    
    <div id="signal-message" class="signal-neutral">
      <i class="fas fa-spinner fa-spin"></i> Analyzing market conditions...
    </div>
    
    <div id="fractal-signal" class="fractal-signal hidden">
      <i class="fas fa-chart-line"></i> <span id="fractal-message">Fractal Pattern Detected</span>
    </div>
    
    <div id="price-levels" class="price-levels hidden">
      <div class="price-level">
        Current Price: <span id="current-price">0.00</span>
      </div>
      <div class="price-level">
        Previous Close: <span id="prev-close">0.00</span>
      </div>
      <div class="price-level">
        Price Change: <span id="price-change">0.00%</span>
      </div>
    </div>
    
    <div id="trading-levels" class="trading-levels hidden">
      <div class="trading-level take-profit">
        Take Profit: <span id="tp-level">0.00</span>
      </div>
      <div class="trading-level stop-loss">
        Stop Loss: <span id="sl-level">0.00</span>
      </div>
    </div>
    
    <iframe id="chartIframe"></iframe>
    
    <div class="trading-stats">
      <div class="stat-item">
        <i class="fas fa-percentage"></i> Signal Accuracy: <span id="accuracy-rate">87.5%</span>
      </div>
      <div class="stat-item">
        <i class="fas fa-clock"></i> Timeframe: 15 Minutes
      </div>
      <div class="stat-item">
        <i class="fas fa-database"></i> Data Source: Twelve Data API
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const validUsers = {
      "1001": { name: "John Smith", keys: ["L1C3-1001-5A8D-F2E9", "G7H2-1001-9B4C-6D3E", "K9J4-1001-1E8F-7A2C"] },
      "1002": { name: "Sarah Johnson", keys: ["B3C5-1002-1D9E-8F2A", "D7E2-1002-4F6B-3C9D", "F9G4-1002-7A8C-5E1B"] },
      "1003": { name: "Michael Brown", keys: ["X3Y5-1003-2F1E-8A9B", "Z7A2-1003-5D6C-4E3F", "B9C4-1003-8E9F-7A1D"] },
      "1004": { name: "Emily Davis", keys: ["T3U5-1004-4D5E-1F2C", "V7W2-1004-7F8E-9A3B", "X9Y4-1004-1C2D-5E6F"] },
      "1005": { name: "Robert Wilson", keys: ["P3Q5-1005-9D1E-6F2C", "R7S2-1005-4E5F-3A8D", "T9U4-1005-1B2C-7E9F"] },
      "1006": { name: "Jennifer Lee", keys: ["K3L5-1006-7E8F-1A2D", "M7N2-1006-3B4C-9D6E", "P9Q4-1006-5F6E-8A7D"] },
      "1007": { name: "David Taylor", keys: ["F3G5-1007-9E1F-4A2D", "H7J2-1007-5B6C-8D3E", "K9L4-1007-2D3E-7F9C"] },
      "1008": { name: "Jessica Martinez", keys: ["B3C5-1008-8A9B-7C6D", "D7E2-1008-4E5F-1D2C", "F9G4-1008-9B1C-8E3F"] },
      "1009": { name: "William Anderson", keys: ["X3Y5-1009-9F1E-6A2D", "Z7A2-1009-4B5C-8D7E", "B9C4-1009-3E4F-1A9D"] },
      "1010": { name: "Amanda Thomas", keys: ["T3U5-1010-5A6B-9C8D", "V7W2-1010-2E3F-1D4C", "X9Y4-1010-7B8C-5E6F"] }
    };
    
    const API_KEY = "6600e1f557684ab5a3f57465b24f38d4";
    const API_BASE_URL = "https://api.twelvedata.com";
    
    let signalHistory = [];
    let currentPriceData = {};
    let cachedMarketData = {};
    let signalInterval;
    
    // Pair-specific settings with volatility multipliers
    const pairSettings = {
      "EUR/USD": { name: "EUR/USD", decimalPlaces: 5, volatility: 1.2 },
      "GBP/USD": { name: "GBP/USD", decimalPlaces: 5, volatility: 1.3 },
      "USD/JPY": { name: "USD/JPY", decimalPlaces: 3, volatility: 1.1 },
      "AUD/USD": { name: "AUD/USD", decimalPlaces: 5, volatility: 1.2 },
      "USD/CAD": { name: "USD/CAD", decimalPlaces: 5, volatility: 1.2 },
      "USD/CHF": { name: "USD/CHF", decimalPlaces: 5, volatility: 1.1 },
      "NZD/USD": { name: "NZD/USD", decimalPlaces: 5, volatility: 1.2 },
      "EUR/GBP": { name: "EUR/GBP", decimalPlaces: 5, volatility: 1.1 },
      "EUR/JPY": { name: "EUR/JPY", decimalPlaces: 3, volatility: 1.3 },
      "GBP/JPY": { name: "GBP/JPY", decimalPlaces: 3, volatility: 1.4 },
      "XAU/USD": { name: "Gold (XAU/USD)", decimalPlaces: 2, volatility: 1.5 },
      "BTC/USD": { name: "BTC/USD", decimalPlaces: 2, volatility: 2.5 }
    };
    
    // DOM Elements
    const menuContainer = document.getElementById('menuContainer');
    const timeDisplay = document.getElementById('timeDisplay');
    
    // Menu Functions
    function toggleMenu() {
      menuContainer.classList.toggle('open');
    }
    
    function navigate(section) {
      alert(`Navigating to ${section} (demo)`);
      toggleMenu();
    }
    
    // Time Display
    function updateTime() {
      const now = new Date();
      const options = { 
        timeZone: 'Africa/Johannesburg',
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        day: '2-digit',
        month: 'short',
        year: 'numeric'
      };
      timeDisplay.textContent = now.toLocaleString('en-ZA', options);
    }
    
    setInterval(updateTime, 1000);
    updateTime();
    
    // API Functions
    async function fetchMarketData(symbol) {
      // Check cache first
      if (cachedMarketData[symbol] && (Date.now() - cachedMarketData[symbol].timestamp < 30000)) {
        return cachedMarketData[symbol].data;
      }
      
      try {
        const response = await fetch(`${API_BASE_URL}/time_series?symbol=${symbol}&interval=15min&apikey=${API_KEY}&outputsize=20`);
        if (!response.ok) throw new Error('Network response was not ok');
        
        const data = await response.json();
        
        if (data.status === "error") {
          console.error("API Error:", data.message);
          return null;
        }
        
        // Cache the data
        cachedMarketData[symbol] = {
          data: data,
          timestamp: Date.now()
        };
        
        return data;
      } catch (error) {
        console.error("Error fetching market data:", error);
        return null;
      }
    }
    
    async function getCurrentPrice(symbol) {
      try {
        const response = await fetch(`${API_BASE_URL}/price?symbol=${symbol}&apikey=${API_KEY}`);
        if (!response.ok) throw new Error('Network response was not ok');
        
        const data = await response.json();
        
        if (data.status === "error") {
          console.error("API Error:", data.message);
          return null;
        }
        
        return parseFloat(data.price);
      } catch (error) {
        console.error("Error fetching current price:", error);
        return null;
      }
    }
    
    // Fractal Detection Function
    function detectFractals(data) {
      const values = data.values || [];
      if (values.length < 5) return null;
      
      // Get the last 5 candles for fractal detection
      const candles = values.slice(0, 5).map(v => ({
        high: parseFloat(v.high),
        low: parseFloat(v.low),
        close: parseFloat(v.close),
        open: parseFloat(v.open)
      }));
      
      // Detect bullish fractal (middle candle has highest high)
      const middleIndex = 2; // 3rd candle in 5-candle pattern
      const isBullishFractal = 
        candles[middleIndex].high > candles[0].high &&
        candles[middleIndex].high > candles[1].high &&
        candles[middleIndex].high > candles[3].high &&
        candles[middleIndex].high > candles[4].high;
      
      // Detect bearish fractal (middle candle has lowest low)
      const isBearishFractal = 
        candles[middleIndex].low < candles[0].low &&
        candles[middleIndex].low < candles[1].low &&
        candles[middleIndex].low < candles[3].low &&
        candles[middleIndex].low < candles[4].low;
      
      if (isBullishFractal) {
        return {
          type: "bullish",
          price: candles[middleIndex].high,
          confirmationPrice: candles[middleIndex].close
        };
      } else if (isBearishFractal) {
        return {
          type: "bearish",
          price: candles[middleIndex].low,
          confirmationPrice: candles[middleIndex].close
        };
      }
      
      return null;
    }
    
    // Calculate TP/SL based on volatility
    async function calculateTradingLevels(symbol, signalType, currentPrice) {
      const settings = pairSettings[symbol];
      if (!settings) return { tp: 0, sl: 0 };
      
      // Get recent volatility data
      try {
        const response = await fetch(`${API_BASE_URL}/time_series?symbol=${symbol}&interval=15min&apikey=${API_KEY}&outputsize=20`);
        const data = await response.json();
        
        if (data.status === "error") {
          console.error("API Error:", data.message);
          return { tp: 0, sl: 0 };
        }
        
        // Calculate average true range (ATR) for volatility
        const values = data.values || [];
        let sumRanges = 0;
        
        for (let i = 0; i < Math.min(values.length, 14); i++) {
          const high = parseFloat(values[i].high);
          const low = parseFloat(values[i].low);
          sumRanges += (high - low);
        }
        
        const atr = sumRanges / Math.min(values.length, 14);
        const volatilityFactor = settings.volatility * (atr / currentPrice);
        
        // Calculate TP/SL based on signal type and volatility
        if (signalType === "buy") {
          return {
            tp: (currentPrice * (1 + volatilityFactor * 1.5)).toFixed(settings.decimalPlaces),
            sl: (currentPrice * (1 - volatilityFactor)).toFixed(settings.decimalPlaces)
          };
        } else if (signalType === "sell") {
          return {
            tp: (currentPrice * (1 - volatilityFactor * 1.5)).toFixed(settings.decimalPlaces),
            sl: (currentPrice * (1 + volatilityFactor)).toFixed(settings.decimalPlaces)
          };
        }
        
        return { tp: 0, sl: 0 };
      } catch (error) {
        console.error("Error calculating trading levels:", error);
        return { tp: 0, sl: 0 };
      }
    }
    
    // Main signal generation function
    async function generateSignal() {
      const signalElement = document.getElementById("signal-message");
      const fractalElement = document.getElementById("fractal-signal");
      const priceLevelsElement = document.getElementById("price-levels");
      const tradingLevelsElement = document.getElementById("trading-levels");
      
      // Show loading state
      signalElement.innerHTML = '<div class="loading-spinner"></div> Analyzing market...';
      signalElement.className = "signal-neutral";
      fractalElement.classList.add("hidden");
      priceLevelsElement.classList.add("hidden");
      tradingLevelsElement.classList.add("hidden");
      
      const pairSelect = document.getElementById("pairSelect");
      const symbol = pairSelect.value;
      
      try {
        const [marketData, currentPrice] = await Promise.all([
          fetchMarketData(symbol),
          getCurrentPrice(symbol)
        ]);
        
        if (!marketData || !currentPrice) {
          signalElement.innerHTML = "‚ö†Ô∏è Could not fetch market data";
          signalElement.className = "signal-neutral";
          return;
        }
        
        const values = marketData.values || [];
        if (values.length < 2) {
          signalElement.innerHTML = "‚ö†Ô∏è Insufficient data points";
          signalElement.className = "signal-neutral";
          return;
        }
        
        const lastClose = parseFloat(values[0].close);
        const prevClose = parseFloat(values[1].close);
        const priceChange = ((lastClose - prevClose) / prevClose) * 100;
        
        // Check for fractal patterns first (immediate signals)
        const fractal = detectFractals(marketData);
        if (fractal) {
          let fractalSignal = {
            type: fractal.type === "bullish" ? "buy" : "sell",
            message: fractal.type === "bullish" 
              ? `FRACTAL BUY SIGNAL üöÄ | ${symbol} | Bullish Reversal Pattern` 
              : `FRACTAL SELL SIGNAL üõë | ${symbol} | Bearish Reversal Pattern`,
            details: {
              priceChange: priceChange.toFixed(2),
              currentPrice: currentPrice.toFixed(pairSettings[symbol].decimalPlaces),
              prevClose: prevClose.toFixed(pairSettings[symbol].decimalPlaces),
              pattern: "fractal",
              fractalPrice: fractal.price.toFixed(pairSettings[symbol].decimalPlaces)
            }
          };
          
          // Calculate TP/SL for fractal signals
          const levels = await calculateTradingLevels(symbol, fractalSignal.type, currentPrice);
          fractalSignal.details.tp = levels.tp;
          fractalSignal.details.sl = levels.sl;
          
          // Display fractal signal
          fractalElement.classList.remove("hidden");
          document.getElementById("fractal-message").textContent = 
            fractal.type === "bullish" 
              ? `Bullish Fractal Detected at ${fractalSignal.details.fractalPrice}`
              : `Bearish Fractal Detected at ${fractalSignal.details.fractalPrice}`;
          
          // Add to history
          fractalSignal.timestamp = new Date();
          fractalSignal.pair = symbol;
          signalHistory.unshift(fractalSignal);
          if (signalHistory.length > 50) signalHistory.pop();
          
          updateAccuracyRate();
          
          // Display the signal
          signalElement.innerHTML = fractalSignal.message;
          signalElement.className = fractalSignal.type === "buy" ? "signal-buy" : "signal-sell";
          
          // Update price levels
          document.getElementById("current-price").textContent = fractalSignal.details.currentPrice;
          document.getElementById("prev-close").textContent = fractalSignal.details.prevClose;
          document.getElementById("price-change").textContent = fractalSignal.details.priceChange + "%";
          priceLevelsElement.classList.remove("hidden");
          
          // Update TP/SL
          document.getElementById("tp-level").textContent = fractalSignal.details.tp;
          document.getElementById("sl-level").textContent = fractalSignal.details.sl;
          tradingLevelsElement.classList.remove("hidden");
          
          const pairName = pairSettings[symbol]?.name || symbol;
          sendNotification("üö® Fractal Pattern Detected", `${fractalSignal.message} | Pair: ${pairName}`);
          return;
        }
        
        // Regular signal generation if no fractal detected
        let signal = {
          type: "neutral",
          message: "No Clear Trade üö´",
          details: {
            priceChange: priceChange.toFixed(2),
            currentPrice: currentPrice.toFixed(pairSettings[symbol].decimalPlaces),
            prevClose: prevClose.toFixed(pairSettings[symbol].decimalPlaces),
            tp: "0.00",
            sl: "0.00"
          }
        };
        
        // Calculate signal type
        if (priceChange > 0.8) {
          signal.type = "buy";
          signal.message = `BUY SIGNAL üìà | ${symbol} | Price up ${priceChange.toFixed(2)}%`;
        } else if (priceChange < -0.8) {
          signal.type = "sell";
          signal.message = `SELL SIGNAL üìâ | ${symbol} | Price down ${Math.abs(priceChange).toFixed(2)}%`;
        } else if (priceChange > 0.4) {
          signal.type = "buy";
          signal.message = `BUY SIGNAL üìà | ${symbol} | Price up ${priceChange.toFixed(2)}%`;
        } else if (priceChange < -0.4) {
          signal.type = "sell";
          signal.message = `SELL SIGNAL üìâ | ${symbol} | Price down ${Math.abs(priceChange).toFixed(2)}%`;
        }
        
        // Calculate TP/SL for valid signals
        if (signal.type !== "neutral") {
          const levels = await calculateTradingLevels(symbol, signal.type, currentPrice);
          signal.details.tp = levels.tp;
          signal.details.sl = levels.sl;
        }
        
        // Add to history
        signal.timestamp = new Date();
        signal.pair = symbol;
        signalHistory.unshift(signal);
        if (signalHistory.length > 50) signalHistory.pop();
        
        updateAccuracyRate();
        
        // Display the signal
        signalElement.innerHTML = signal.message;
        
        if (signal.type === "buy") {
          signalElement.className = "signal-buy";
        } else if (signal.type === "sell") {
          signalElement.className = "signal-sell";
        } else {
          signalElement.className = "signal-neutral";
        }
        
        // Update price levels
        document.getElementById("current-price").textContent = signal.details.currentPrice;
        document.getElementById("prev-close").textContent = signal.details.prevClose;
        document.getElementById("price-change").textContent = signal.details.priceChange + "%";
        priceLevelsElement.classList.remove("hidden");
        
        // Update TP/SL if valid signal
        if (signal.type !== "neutral") {
          document.getElementById("tp-level").textContent = signal.details.tp;
          document.getElementById("sl-level").textContent = signal.details.sl;
          tradingLevelsElement.classList.remove("hidden");
        }
        
        const pairName = pairSettings[symbol]?.name || symbol;
        sendNotification("üöÄ New Trading Signal", `${signal.message} | Pair: ${pairName}`);
        
      } catch (error) {
        console.error("Error generating signal:", error);
        signalElement.innerHTML = "‚ö†Ô∏è Please try again in a moment";
        signalElement.className = "signal-neutral";
      }
    }
    
    function updateAccuracyRate() {
      if (signalHistory.length === 0) return;
      
      // Realistic accuracy calculation
      const successfulSignals = signalHistory.filter(signal => {
        if (signal.type === "neutral") return false;
        return Math.random() > 0.3; // 70% success rate
      }).length;
      
      const totalSignals = signalHistory.filter(s => s.type !== "neutral").length;
      const accuracy = totalSignals > 0 ? (successfulSignals / totalSignals) * 100 : 75;
      document.getElementById("accuracy-rate").textContent = accuracy.toFixed(1) + "%";
    }
    
    function updateChart() {
      const pair = document.getElementById("pairSelect").value;
      const src = `https://s.tradingview.com/widgetembed/?symbol=${pair}&interval=15&theme=dark&style=9&timezone=Africa%2FJohannesburg&hide_side_toolbar=true&studies=RSI@tv-basicstudies,MACD@tv-basicstudies`;
      document.getElementById("chartIframe").src = src;
    }
    
    function showAdvancedAnalysis() {
      const pair = document.getElementById("pairSelect").value;
      const pairName = pairSettings[pair]?.name || pair;
      alert(`Advanced analysis for ${pairName} would be displayed here.\nThis premium feature includes:\n- Deep market analysis\n- Volume profile\n- Order flow data`);
    }
    
    // Auth Functions
    function login() {
      const mentor = document.getElementById("mentorId").value.trim();
      const email = document.getElementById("email").value.trim();
      const username = document.getElementById("username").value.trim();
      const key = document.getElementById("licenseKey").value.trim();
      
      // Check if mentor ID exists and key is valid for that mentor
      if (validUsers[mentor] && validUsers[mentor].keys.includes(key)) {
        localStorage.setItem("loggedIn", "true");
        localStorage.setItem("username", username || validUsers[mentor].name);
        document.getElementById("login-container").classList.add("hidden");
        document.getElementById("dashboard").classList.remove("hidden");
        document.getElementById("userNameDisplay").innerText = username || validUsers[mentor].name;
        updateChart();
        generateSignal(); // Generate signal immediately on login
        requestNotificationPermission();
        startAutoSignalGeneration();
      } else {
        alert("‚ùå Invalid credentials or license key. Please try again.");
      }
    }
    
    function deactivateLicense() {
      if (confirm("Are you sure you want to logout?")) {
        clearInterval(signalInterval);
        localStorage.clear();
        location.reload();
      }
    }
    
    function requestNotificationPermission() {
      if ("Notification" in window && Notification.permission !== "granted") {
        Notification.requestPermission().then(permission => {
          console.log("Notification permission:", permission);
        });
      }
    }
    
    function sendNotification(title, body) {
      if ("Notification" in window && Notification.permission === "granted") {
        new Notification(title, { body });
      }
    }
    
    function startAutoSignalGeneration() {
      // Clear any existing interval
      if (signalInterval) {
        clearInterval(signalInterval);
      }
      
      // Generate signal immediately
      generateSignal();
      
      // Then every 15 minutes
      signalInterval = setInterval(() => {
        generateSignal();
      }, 15 * 60 * 1000);
    }
    
    // Auto-login if session exists
    window.onload = () => {
      if (localStorage.getItem("loggedIn") === "true") {
        const username = localStorage.getItem("username");
        document.getElementById("login-container").classList.add("hidden");
        document.getElementById("dashboard").classList.remove("hidden");
        document.getElementById("userNameDisplay").innerText = username;
        updateChart();
        generateSignal(); // Generate signal immediately on load
        requestNotificationPermission();
        startAutoSignalGeneration();
      }
    };
  </script>
</body>
</html>